<div class="page-header">
  <div class="page-title">
    <span
      [matBadge]="totalItems"
      [matBadgeColor]="totalItems === 0 ? 'warn' : 'primary'"
      matBadgeOverlap="false"
      matBadgePosition="after"
      matBadgeSize="medium">
      Registro Visite
    </span>
  </div>

  <button mat-raised-button
          color="primary"
          *ngIf="perm.canViewRegistroVisite"
          (click)="openDialog()">
    Nuova Visita
  </button>

</div>
<mat-card class="filter-card">

  <div class="filter-grid">
    <!-- Filtro sede solo admin -->
    <mat-form-field *ngIf="perm.canFilterSede"
                    appearance="outline">
      <mat-label>Sede</mat-label>
      <mat-select [(ngModel)]="filtro.sedeId">
        <mat-option [value]="null">Tutte</mat-option>
        <mat-option *ngFor="let s of sedi"
                    [value]="s.id">
          {{ s.descrizione }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    <!-- FILTRI -->
    <mat-form-field appearance="outline">
      <mat-label>Data da</mat-label>
      <input matInput [matDatepicker]="pickerDa"
             [(ngModel)]="filtro.dataDa">
      <mat-datepicker-toggle matIconSuffix [for]="pickerDa"></mat-datepicker-toggle>
      <mat-datepicker #pickerDa></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Data a</mat-label>
      <input matInput [matDatepicker]="pickerA"
             [(ngModel)]="filtro.dataA">
      <mat-datepicker-toggle matIconSuffix [for]="pickerA"></mat-datepicker-toggle>
      <mat-datepicker #pickerA></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Nome cliente</mat-label>
      <input matInput [(ngModel)]="filtro.nomeCliente">
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Provincia</mat-label>
      <mat-select [(ngModel)]="filtro.provincia">
        <mat-option [value]="null">Tutte</mat-option>
        <mat-option *ngFor="let p of province" [value]="p">
          {{p}}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <div class="comune-wrapper">
      <mat-form-field appearance="outline">
        <mat-label>Comune</mat-label>
        <input matInput
               [(ngModel)]="comuneSearch"
               (ngModelChange)="onComuneSearch($event)">
      </mat-form-field>
    </div>



  </div>

  <!-- üî• RIGA PULSANTI SEPARATA SEMPRE -->
  <div class="filter-actions">
    <button mat-stroked-button color="warn" (click)="reset()">
      Reset
    </button>

    <button mat-raised-button color="primary" (click)="cerca()">
      Cerca
    </button>
  </div>

</mat-card>

<mat-card class="table-card">

  <mat-spinner *ngIf="loader" class="loader"></mat-spinner>

  <table mat-table
         *ngIf="!loader"
         [dataSource]="dataSource">
    <ng-container matColumnDef="sede">
      <th mat-header-cell *matHeaderCellDef>Sede</th>
      <td mat-cell *matCellDef="let e">
        {{ e.sedeDescrizione }}
      </td>
    </ng-container>
    <!-- Data -->
    <ng-container matColumnDef="dataVisita">
      <th mat-header-cell *matHeaderCellDef>Data</th>
      <td mat-cell *matCellDef="let e">
        {{ e.dataVisita | date:'dd/MM/yyyy HH:mm' }}
      </td>
    </ng-container>

    <!-- Cliente -->
    <ng-container matColumnDef="nomeCliente">
      <th mat-header-cell *matHeaderCellDef>Cliente</th>
      <td mat-cell *matCellDef="let e">
        <div class="cliente-wrapper">
          <div class="cliente-nome">
            {{ e.nomeCliente }}
          </div>
          <div class="cliente-codice"
               *ngIf="e.codiceCliente">
            Conto: {{ e.codiceCliente }}
          </div>
          <div class="cliente-telefono" *ngIf="e.telefono">
            <mat-icon class="telefono-icon">smartphone</mat-icon>{{ e.telefono }}
          </div>
        </div>
      </td>
    </ng-container>

    <!-- Comune -->
    <ng-container matColumnDef="comune">
      <th mat-header-cell *matHeaderCellDef>Localit√†</th>
      <td mat-cell *matCellDef="let e">
        {{ e.comuneNome }} ({{ e.provinciaSigla }})
      </td>
    </ng-container>

    <!-- Motivo -->
    <ng-container matColumnDef="motivo">
      <th mat-header-cell *matHeaderCellDef>Motivo</th>
      <td mat-cell *matCellDef="let e">
        <div class="motivo-wrapper">

          <!-- Figlio o motivo salvato -->
          <div class="motivo-child">
            {{ e.motivoDescrizione }}
          </div>

          <!-- Padre solo se esiste -->
          <div class="motivo-parent"
               *ngIf="e.motivoParentDescrizione">
            {{ e.motivoParentDescrizione }}
          </div>

        </div>
      </td>
    </ng-container>

    <!-- Venditore -->
    <ng-container matColumnDef="venditore">
      <th mat-header-cell *matHeaderCellDef>Venditore</th>
      <td mat-cell *matCellDef="let e">
        {{ e.venditoreNome }}
      </td>
    </ng-container>

    <!-- Azioni -->
    <ng-container matColumnDef="azioni">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let e">

        <button mat-icon-button (click)="openDialog(e)">
          <mat-icon>edit</mat-icon>
        </button>

        <button mat-icon-button
                color="warn"
                *ngIf="perm.canViewRegistroVisite"
                (click)="delete(e.id)">
          <mat-icon>delete</mat-icon>
        </button>

        <button mat-icon-button
                [color]="e.codiceCliente ? 'accent' : 'primary'"
                (click)="openAssociaCliente(e.id)"
                matTooltip="{{ e.codiceCliente ? 'Cliente associato' : 'Associa cliente' }}">
          <mat-icon>
            {{ e.codiceCliente ? 'link_off' : 'link' }}
          </mat-icon>
        </button>

      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

    <tr *matNoDataRow>
      <td [attr.colspan]="displayedColumns.length">
        Nessuna visita trovata
      </td>
    </tr>

  </table>

  <mat-paginator
    [length]="totalItems"
    [pageSize]="filtro.size"
    [pageIndex]="filtro.page"
    [pageSizeOptions]="[5, 10, 20]"
    (page)="onPageChange($event)">
  </mat-paginator>

</mat-card>
