<div class="container-xxl">

  <div class="row">
    <div class="col-md-12 ordine-title">
      ORDINI DA CONSEGNARE <span><mat-icon (click)="mostraMappa()" color="primary">location_on</mat-icon></span>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-12">
      <div id="map" [ngClass]="{'map-container':showMappa}"></div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-5"></div>
    <div class="col-lg-1"></div>

    <div class="col-lg-6">
      <button class="float-end margin-right" (click)="refreshPage()" mat-raised-button color="primary">Aggiorna lista</button>
    </div>

    <div class="col-lg-12">
      <div class="mat-elevation-z8 container-importo">
        <span *ngFor="let el of importiList" class="box-importo">
          {{el.fullname}}<br>{{el.import | currency:'EUR':'symbol'}}
        </span>
      </div>
    </div>

    <div class="col-lg-12">
      <mat-radio-group (change)="retrieveList()" [(ngModel)]="filtro.codVenditore">
        <mat-radio-button *ngFor="let option of radioPerVenditoreOptions" [checked]="option.checked" [value]="option.codVenditore">
          {{option.fullname}}
        </mat-radio-button>
      </mat-radio-group>
    </div>

    <div class="col-lg-12">
      <mat-radio-group (change)="retrieveList()" [(ngModel)]="filtro.status">
        <mat-radio-button *ngFor="let option of radioPerStatusOptions" [value]="option.codice">
          {{option.descrizione}}
        </mat-radio-button>
      </mat-radio-group>
    </div>

    <div class="col-lg-3">
      <mat-form-field appearance="fill">
        <mat-label>Filtra per data di consegna</mat-label>
        <mat-date-range-input [rangePicker]="picker">
          <input matStartDate placeholder="Start date" [(ngModel)]="filtro.dataConsegnaStart" (dateChange)="getNotaConsegna()">
          <input matEndDate placeholder="End date" [(ngModel)]="filtro.dataConsegnaEnd">
        </mat-date-range-input>
        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-date-range-picker #picker></mat-date-range-picker>
      </mat-form-field>
    </div>

    <div class="col-lg-4">
      <mat-form-field appearance="fill">
        <mat-label>Filtra per tipo di veicolo</mat-label>
        <mat-select [(value)]="filtro.veicolo">
          <mat-option></mat-option>
          <mat-option *ngFor="let option of selectVeicoloOptions" [value]="option.id">
            {{option.descrizione}}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <div class="col-lg-2">
      <mat-form-field>
        <mat-label>Data ordine</mat-label>
        <input matInput [matDatepicker]="pickerDt" [(ngModel)]="filtro.dataOrdine" (ngModelChange)="resetPage()">
        <mat-datepicker-toggle matIconSuffix [for]="pickerDt"></mat-datepicker-toggle>
        <mat-datepicker #pickerDt></mat-datepicker>
      </mat-form-field>
    </div>

    <div class="col-lg-3">
      <button class="float-end btn-container" mat-mini-fab color="primary" (click)="addOrder()" matTooltip="Cerca e aggiungi ordini pregressi">
        <span class="material-icons-outlined icon">playlist_add</span>
      </button>
    </div>
  </div>

  <div class="row cerca">
    <div class="col-md-1">
      <mat-form-field>
        <mat-label>Anno</mat-label>
        <input matInput type="number" [(ngModel)]="filtro.anno" (ngModelChange)="resetPage()">
      </mat-form-field>
    </div>

    <div class="col-md-2">
      <mat-form-field>
        <mat-label>Progr.</mat-label>
        <input matInput type="number" [(ngModel)]="filtro.progressivo" (ngModelChange)="resetPage()">
      </mat-form-field>
    </div>

    <div class="col-md-3">
      <mat-form-field>
        <mat-label>Cliente</mat-label>
        <input matInput type="text" [(ngModel)]="filtro.cliente" (ngModelChange)="resetPage()">
      </mat-form-field>
    </div>

    <div class="col-md-2">
      <mat-form-field>
        <mat-label>Luogo</mat-label>
        <input matInput type="text" [(ngModel)]="filtro.luogo" (ngModelChange)="resetPage()">
      </mat-form-field>
    </div>

    <div class="col-md-1">
      <button mat-raised-button color="warn" (click)="reset()">Reset</button>
    </div>

    <div class="col-md-1">
      <button mat-raised-button color="primary" (click)="retrieveList()">Cerca</button>
    </div>
  </div>

  <!-- NOTE CONSEGNA -->
  <div class="row" *ngIf="checkdate()">
    <div class="col-lg-6">
      <form>
        <mat-form-field class="example-full-width">
          <mat-label>Note consegna del giorno {{filtro.dataConsegnaStart | date:'dd/MM/yyyy'}}</mat-label>
          <textarea name="nota" [(ngModel)]="notaConsegna.nota" matInput maxlength="2000"></textarea>
          <mat-hint align="end">{{notaConsegna.nota.length}} / 2000</mat-hint>
        </mat-form-field>
      </form>
    </div>

    <div class="col-lg-1">
      <button mat-button color="primary" (click)="saveNotaConsegna()" matTooltip="Salva nota">
        <mat-icon fontIcon="save"></mat-icon>
      </button>
    </div>
  </div>

  <!-- LISTA PRINCIPALE -->
  <div class="row">
    <div class="col-lg-12">
      <div class="mat-elevation-z8">
        <mat-spinner *ngIf="loader" class="loader"></mat-spinner>

        <table class="table-container" *ngIf="!loader" mat-table [dataSource]="dataSource" multiTemplateDataRows>

          <!-- Numero -->
          <ng-container matColumnDef="numero">
            <th mat-header-cell *matHeaderCellDef>Numero Ordine</th>
            <td mat-cell *matCellDef="let ordine" class="pointer"
                (click)="getArticoli(ordine); (expandedElement = expandedElement === ordine ? null : ordine); $event.stopPropagation()">
              {{ordine.anno}}/{{ordine.serie}}/{{ordine.progressivo}}
            </td>
          </ng-container>

          <!-- Cliente -->
          <ng-container matColumnDef="cliente">
            <th mat-header-cell *matHeaderCellDef>Cliente</th>
            <td mat-cell *matCellDef="let ordine" class="pointer"
                (click)="getArticoli(ordine); (expandedElement = expandedElement === ordine ? null : ordine); $event.stopPropagation()">
              <span matTooltip="{{ordine.telefono}} - {{ordine.cellulare}}">{{ordine.intestazione}}</span>
              <br><span style="font-size:11px">{{ordine.sottoConto}}</span>
              <br><span style="font-size:11px">{{ordine.riferimento}}</span>
            </td>
          </ng-container>

          <!-- Località -->
          <ng-container matColumnDef="localita">
            <th mat-header-cell *matHeaderCellDef>Luogo</th>
            <td mat-cell *matCellDef="let ordine" class="pointer"
                (click)="getArticoli(ordine); (expandedElement = expandedElement === ordine ? null : ordine); $event.stopPropagation()">
              <span matTooltip="Consegnare in {{ordine.indirdiverse}} - {{ordine.locdiverse}} ({{ordine.provdiverse}})">
                {{ordine.localita}} ({{ordine.provincia}})
              </span>
            </td>
          </ng-container>

          <!-- Data -->
          <ng-container matColumnDef="data">
            <th mat-header-cell *matHeaderCellDef>Data</th>
            <td mat-cell *matCellDef="let ordine" class="pointer"
                (click)="getArticoli(ordine); (expandedElement = expandedElement === ordine ? null : ordine); $event.stopPropagation()">
              {{ordine.dataConferma | date:'dd/MM/yyyy'}}
            </td>
          </ng-container>

          <!-- Status -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef> Stato Ord </th>
            <td mat-cell *matCellDef="let ordine">

              <!-- SE NON HA PERMESSO → testo normale -->
              <div *ngIf="!canModificaStatus" [ngSwitch]="ordine.status">
                <b *ngSwitchCase="'DA_PROCESSARE'">DA PROCESSARE</b>
                <b *ngSwitchCase="'DA_ORDINARE'">DA ORDINARE</b>
                <b *ngSwitchDefault>{{ordine.status}}</b>
              </div>

              <!-- SE HA PERMESSO → select -->
              <div *ngIf="canModificaStatus" class="stato">
                <mat-select [(value)]="ordine.status" class="select">
                  <mat-option *ngFor="let option of selectStatusOptions" [value]="option.codice">
                    {{option.descrizione}}
                  </mat-option>
                </mat-select>
                <button mat-button color="primary" *ngIf="canSalvaStatus" (click)="update(ordine)">
                  <mat-icon fontIcon="save"></mat-icon>
                </button>
              </div>

            </td>
          </ng-container>

          <!-- Data consegna -->
          <ng-container matColumnDef="dataConsegna">
            <th mat-header-cell *matHeaderCellDef>Data Consegna</th>
            <td mat-cell *matCellDef="let ordine">
              <mat-form-field>
                <input matInput [matDatepicker]="picker" [(ngModel)]="ordine.dataConsegna">
                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
              </mat-form-field>
            </td>
          </ng-container>

          <!-- Ora consegna -->
          <ng-container matColumnDef="oraConsegna">
            <th mat-header-cell *matHeaderCellDef>Consegna</th>
            <td mat-cell *matCellDef="let ordine">
              <mat-select [(value)]="ordine.oraConsegna" class="select">
                <mat-option [value]="'M'">Mattina</mat-option>
                <mat-option [value]="'P'">Pomeriggio</mat-option>
              </mat-select>
            </td>
          </ng-container>

          <!-- Ordinamento consegna -->
          <ng-container matColumnDef="ordinamento">
            <th mat-header-cell *matHeaderCellDef>Ord. Cons.</th>
            <td mat-cell *matCellDef="let ordine">
              <input type="number" [(ngModel)]="ordine.ordine" min="0" class="form-control input">
            </td>
          </ng-container>

          <!-- Veicolo -->
          <ng-container matColumnDef="veicolo">
            <th mat-header-cell *matHeaderCellDef>Veicolo</th>
            <td mat-cell *matCellDef="let ordine">
              <mat-select [(value)]="ordine.veicolo" class="select">
                <mat-option></mat-option>
                <mat-option *ngFor="let option of selectVeicoloOptions" [value]="option.id">
                  {{option.descrizione}}
                </mat-option>
              </mat-select>

              <button mat-button color="primary"
                      *ngIf="canModificaVeicolo && ordine.ordine && ordine.oraConsegna"
                      (click)="updateVeicolo(ordine)">
                <mat-icon fontIcon="save"></mat-icon>
              </button>
            </td>
          </ng-container>

          <!-- Azioni -->
          <ng-container matColumnDef="azioni">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let ordine">
              <!-- NOTE CLIENTE -->
              <button mat-icon-button (click)="aggiungiNote(ordine,0)" [matTooltip]="ordine.note" matTooltipClass="note">
                <mat-icon fontIcon="speaker_notes" color="primary"
                          [ngClass]="{'nota-presente':ordine.note}"></mat-icon>
              </button>

              <!-- NOTE LOGISTICA (SOLO PERMESSO) -->
              <button mat-icon-button (click)="aggiungiNote(ordine,1)"
                      *ngIf="canAggiungiNoteLogistica"
                      [matTooltip]="ordine.noteLogistica"
                      matTooltipClass="note">
                <mat-icon fontIcon="contact_phone" color="primary"
                          [ngClass]="{'nota-logistica-presente':ordine.noteLogistica}"></mat-icon>
              </button>

              <button mat-icon-button matTooltip="Sono presenti articoli consegnati senza bolla"
                      *ngIf="ordine.warnNoBolla" #tooltip="matTooltip" (click)="tooltip.toggle()">
                <mat-icon class="warnNoBolla" fontIcon="report" color="warn"></mat-icon>
              </button>

              <button mat-icon-button [matTooltip]="'Articoli in pronta consegna'"
                      *ngIf="ordine.hasProntoConsegna"
                      #tooltip="matTooltip" (click)="tooltip.toggle()">
                <mat-icon fontIcon="rocket_launch" color="primary"></mat-icon>
              </button>
            </td>
          </ng-container>

          <!-- Detail expand -->
          <ng-container matColumnDef="expandedDetail">
            <td mat-cell *matCellDef="let ordine" [attr.colspan]="displayedColumns.length">

              <div [@detailExpand]="ordine == expandedElement ? 'expanded' : 'collapsed'">

                <mat-spinner *ngIf="loaderDettaglio" class="loader"></mat-spinner>

                <table class="table" *ngIf="!loaderDettaglio">
                  <thead>
                  <tr>
                    <th>Cod.:</th>
                    <th>Cod. forn.:</th>
                    <th>Descr.:</th>
                    <th>Qta da cons.:</th>
                    <th>Qta tot.:</th>
                    <th>U.M.:</th>
                    <th>
                      <button class="float-end" (click)="apriFidoClienteModal(ordine)" mat-button matTooltip="Mostra Fido cliente">
                        <mat-icon color="primary">receipt_long</mat-icon>
                      </button>
                    </th>
                  </tr>
                  </thead>

                  <tbody>
                  <tr *ngFor="let articolo of articoli">
                    <td>{{articolo.farticolo}}</td>
                    <td>{{articolo.codArtFornitore}}</td>
                    <td>{{articolo.fdescrArticolo}}</td>

                    <td>
                      <span *ngIf="mostraNonDisponibile(articolo) === 0">
                        {{articolo.qtaDaConsegnare | number:'1.2-2'}}
                      </span>
                      <span *ngIf="mostraNonDisponibile(articolo) === 1">N.D.</span>
                      <span *ngIf="mostraNonDisponibile(articolo) === 2"></span>
                    </td>

                    <td><span *ngIf="articolo.tipoRigo === '' || articolo.tipoRigo === ' '">
                      {{articolo.quantita | number:'1.2-2'}}
                    </span></td>

                    <td>{{articolo.funitaMisura}}</td>

                    <td>
                      <button *ngIf="articolo.tipoRigo !=='C' && articolo.tipoRigo !=='AC' && articolo.annoOAF"
                              mat-button
                              matTooltip="Rif {{articolo.annoOAF}}/{{articolo.serieOAF}}/{{articolo.progressivoOAF}} del {{articolo.dataOrdineOAF | date:'dd/MM/yyyy'}}"
                              #tooltip="matTooltip"
                              (click)="tooltip.toggle()">

                        <mat-icon aria-hidden="false">store</mat-icon>
                      </button>
                    </td>
                  </tr>
                  </tbody>
                </table>

              </div>

            </td>
          </ng-container>


          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>

          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell no-result-list" colspan="4">Nessun risultato</td>
          </tr>

        </table>

        <mat-paginator
          aria-label="Select page of ordini clienti"
          [length]="totalItems"
          [pageSize]="filtro.size"
          [pageSizeOptions]="[5,10,20,30]"
          (page)="onPageChange($event)"
          [showFirstLastButtons]="true"
          [pageIndex]="filtro.page">
        </mat-paginator>

      </div>
    </div>
  </div>

</div>
